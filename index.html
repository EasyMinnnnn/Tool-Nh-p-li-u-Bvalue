<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>AutoFill Tool</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    textarea {
      width: 100%;
      height: 200px;
    }
    button {
      margin-top: 10px;
      padding: 10px;
    }
  </style>
</head>
<body>
  <h2>üöÄ AutoFill Tool</h2>
  <p>D√°n d·ªØ li·ªáu t·ª´ Excel (m·∫£ng ƒë·ªëi t∆∞·ª£ng c√≥ <code>xpath</code> v√† <code>value</code>)</p>
  <textarea id="dataInput" placeholder='[{ "xpath": "...", "value": "..." }, ...]'></textarea>
  <br>
  <button onclick="runScript()">Ch·∫°y AutoFill</button>

  <script>
    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function fillField(xpath, value) {
      if (!value || value.trim() === '') {
        console.warn('‚ùå B·ªè qua gi√° tr·ªã tr·ªëng:', xpath);
        return;
      }

      const el = document.evaluate(xpath, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
      if (!el) {
        console.warn('‚ùå Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠:', xpath);
        return;
      }

      el.focus();
      if (el.tagName === 'SELECT') {
        let found = false;
        for (const option of el.options) {
          if (option.text.trim() === value.trim()) {
            el.value = option.value;
            found = true;
            break;
          }
        }
        if (!found) {
          console.warn('‚ùå Kh√¥ng t√¨m th·∫•y option ph√π h·ª£p:', value, xpath);
        }
        el.dispatchEvent(new Event('change', { bubbles: true }));
      } else {
        el.value = value;
        el.dispatchEvent(new InputEvent('input', { bubbles: true }));
        el.dispatchEvent(new Event('change', { bubbles: true }));
      }
      console.log('‚úÖ ƒê√£ ƒëi·ªÅn:', xpath, '->', value);
    }

    async function runScript() {
      try {
        const raw = document.getElementById('dataInput').value;
        const data = eval(raw); // C·∫£nh b√°o: d√πng eval khi b·∫°n ch·∫Øc ch·∫Øn n·ªôi dung ƒë√∫ng
        for (const { xpath, value } of data) {
          await fillField(xpath, value);
          await delay(100); // delay nh·∫π ƒë·ªÉ tr√°nh l·ªói khi DOM c·∫≠p nh·∫≠t ch·∫≠m
        }
        alert('‚úÖ Ho√†n t·∫•t ƒëi·ªÅn form!');
      } catch (e) {
        alert('‚ùå L·ªói khi ch·∫°y m√£: ' + e.message);
        console.error(e);
      }
    }
  </script>
</body>
</html>
